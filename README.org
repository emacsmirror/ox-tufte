#+TITLE: Ox-tufte
#+AUTHOR: The Bayesians Inc.

* Introduction
[[https://edwardtufte.github.io/tufte-css/][Tufte CSS]] has visually appealing defaults for webpages and supports (among other
things) margin and side notes. Unfortunately, /Tufte CSS/ makes a number of
demands of the HTML structure. This is a pity, because the HTML generated by
=ox-html= breaks some of those assumptions (of =tufte-css=). Using =ox-tufte=
you can avail the features of =tufte-css= when exporting an org-mode file to
HTML. Since version 2+, the design goal of =ox-tufte= has been to "minimally"
change the HTML structure generated by =ox-html= (with additional CSS as needed)
to get behaviour that is equivalent to =tufte-css=.

It's still a work-in-progress, but it is being used by at least one blog in
"production".
* Installation and Usage
You can install ox-tufte using [[https://melpa.org][MELPA]]:
#+BEGIN_SRC emacs-lisp
(add-to-list 'package-archives
             '("melpa" . "http://melpa.org/packages/") t)

(package-refresh-contents)
(package-install 'ox-tufte)
#+END_SRC

And then in your ~init.el~ (or equivalent):
#+BEGIN_SRC emacs-lisp
  (require 'ox-tufte)
  (ox-tufte/init)
#+END_SRC

For usage, when exporting simply select "Tufte HTML" instead of regular HTML
export from the export menu (=C-c C-e=).

It's important that you download [[https://github.com/edwardtufte/tufte-css][tufte css]] and place it on your server (with the
fonts) and then reference it from your org-mode document by adding a header such
as:
#+BEGIN_SRC org
,#+HTML_HEAD: <link rel="stylesheet" href="/css/tufte.css" type="text/css" />
#+END_SRC

* Features
ox-tufte supports *most* of the features from tufte-css, some in different ways
than expected, and some extensions.
| [[https://edwardtufte.github.io/tufte-css/][Tufte-css concept]]     | [[https://orgmode.org/worg/org-syntax.html][Org-mode syntax]] for tufte-css concept      | ox-tufte extension                                |
|-----------------------+--------------------------------------------+---------------------------------------------------|
| [[https://edwardtufte.github.io/tufte-css/#fundamentals--sections-and-headers][Sections and Headings]] | Sections and Headings                      |                                                   |
| [[https://edwardtufte.github.io/tufte-css/#sidenotes][Sidenotes]]             | [[footnotes][Footnotes]]                                  |                                                   |
| [[https://edwardtufte.github.io/tufte-css/#sidenotes][Margin-notes]]          | [[marginnotes-inline][inline babel call]] to [[marginnote]["marginnote" block]]    | block margin-notes via "marginnote" special-block |
| [[https://edwardtufte.github.io/tufte-css/#epigraphs][Epigraphs]]             | [[epigraphs][Quote block]]                                |                                                   |
| [[https://edwardtufte.github.io/tufte-css/#figures][iframe wrapper]]        | [[figures]["figure"]] org-mode [[https://orgmode.org/org.html#HTML-doctypes][special-block]]            |                                                   |
| [[https://edwardtufte.github.io/tufte-css/#code][Code]]                  | [[code][Source block]]                               |                                                   |
| [[https://edwardtufte.github.io/tufte-css/#imagequilts][ImageQuilts]]           | [[https://orgmode.org/manual/Images.html][Images]] (optionally with =fullwidth= class) |                                                   |

** [[https://edwardtufte.github.io/tufte-css/#sidenotes][Sidenotes and margin-notes]]
- <<footnotes>>Org-mode footnotes become numbered Sidenotes from the tufte spec
- +Margin notes can be created by having a link to ~mn:<n>~ where the link text
  gets transformed to the margin note, for example:+

#+BEGIN_SRC org
  This is some regular text [[mn:1][this will be a margin note]] and some more
  text [[mn:][another margin note]].
#+END_SRC

<<marginnotes-inline>>The above syntax is limiting since in org, link
descriptions cannot contain regular links. The more feature-ful embedding of
"inline" margin-notes (i.e., margin-notes that can include [[https://html.spec.whatwg.org/#phrasing-content-2][HTML phrasing
content]]) is as an inline babel call, specifically, to [[marginnote][the marginnote block
below]].
#+name: marginnote
#+header: :var input=""
#+begin_src elisp :exports results :results html replace value
  (require 'ox-tufte)
  (ox-tufte/utils/margin-note input)
#+end_src

There is also support for "block" margin-notes, which are margin-notes that can
contain "block" elements ([[https://html.spec.whatwg.org/#flow-content-2][HTML spec flow content]]) such as paragraphs, lists,
tables etc. These are defined using an org-mode "marginnote" special-block
(i.e., within =#+begin_marginnote= and =#+end_marginnote=, or within
=#+BEGIN_marginnote= and =#+END_marginnote=).
#+begin_src org
  ,#+begin_marginnote
  This is a block level margin-note.
  - item 1
  - item 2
  ,#+end_marginnote
#+end_src
** <<epigraphs>>[[https://edwardtufte.github.io/tufte-css/#epigraphs][Epigraphs]]
- Anything in =#+BEGIN_QUOTE= blocks becomes an epigraph, where the =#+NAME= of
  the quote becomes a reference in the ~<footer>~ inside of the epigraph.
- Verses (=#+BEGIN_VERSE=) are treated the same as quotes, however they preserve
  leading spaces in the text
** <<code>>[[https://edwardtufte.github.io/tufte-css/#code][Code]]
=ox-tufte= uses =ox-html= to export [[https://orgmode.org/manual/Literal-Examples.html][code fragments]] to HTML (without any
alteration). =ox-html= and [[https://elpa.nongnu.org/nongnu/htmlize.html][=htmlize=]] allow one to customize the syntax
highlighting of the exported code blocks. An Emacs color theme that is visually
consistent with =tufte-css= is the [[https://melpa.org/#/plan9-theme][=plan9-theme=]] which can be installed from
Melpa via something like:
#+begin_src elisp
  (add-to-list 'package-archives
               '("melpa" . "http://melpa.org/packages/") t)

  (package-refresh-contents)
  (package-install 'plan9-theme)
#+end_src
And then in your =init.el= or equivalent, load it using:
src_elisp{(load-theme 'plan9 t)}.
** <<figures>>Figures and iframes
To use =tufte-css='s =iframe-wrapper= class, one can do something like below:
#+begin_src org
  ,#+ATTR_HTML: :class iframe-wrapper
  ,#+begin_figure
  @@html:<iframe width="853" height="480" src="https://www.youtube.com/embed/YslQ2625TR4" frameborder="0" allowfullscreen></iframe>@@
  ,#+end_figure
#+end_src

To have fullwidth figures:
#+begin_src org
  ,#+ATTR_HTML: :class fullwidth
  ,#+CAPTION: Edward Tufte’s English translation of the Napoleon’s March data visualization. From Beautiful Evidence, page 122-124.
  [[https://edwardtufte.github.io/tufte-css/img/napoleons-march.png]]
  ,#+end_figure
#+end_src
** Deviations and Extensions
- captions on images are placed below the image (as opposed to in the margin
  area) regardless of whether the image is =fullwidth= or not.
- h4 heading level is supported in a consistent manner similar to h3.
- block level margin notes are supported via src_org{#+begin_marginnote} and
  src_org{#+end_marginnote}.
  
** Experimental
There are some experimental extensions in [[file:ox-tufte-experimental.css][ox-tufte-experimental.css]]. This css
file should be included /after/ [[file:ox-tufte.css][ox-tufte.css]].
* Limitations
ox-tufte presently inherits the following limitations from [[https://edwardtufte.github.io/tufte-css/][tufte-css]]:
- Sidenotes cannot contain paragraphs, tables etc. (since they are HTML =span=
  elements).

In addition there are [[todos][some pending TODOs]].
* Customization
** Footnotes section at bottom
The behaviour depends on the value of
~org-tufte-include-footnotes-at-bottom~. Because footnotes are transformed to
sidenotes they are currently hidden on very narrow screens (like phones), unless
the use manually toggles visibility for each reference. if you want to include
footnodes *also* at the bottom of the page, this may be set to =t= using either
=setq= (src_elisp{(setq org-tufte-include-footnotes-at-bottom t)}), or, more
conveniently, during initial setup by passing =t= to =ox-tufte/init=:
#+begin_src elisp
  (ox-tufte/init t)
#+end_src

This behaviour can also be configured on a per-file basis
(assuming =org-export-allow-bind-keywords= is =t=) using below:
#+begin_src org
  ,#+BIND: org-tufte-include-footnotes-at-bottom nil
#+end_src
** Margin-note symbol and visibility on small screens
From [[https://edwardtufte.github.io/tufte-css/][tufte-css]]:
#+begin_quote
However, on small screens, a margin note is like a sidenote except its
viewability-toggle is a symbol rather than a reference number. This document
currently uses the symbol ⊕ (&#8853;), but it’s up to you.
#+end_quote
This symbol can be tweaked, by modifying the value of
=org-tufte-margin-note-symbol=. Specifically, if this value is set to the empty
string (=""=), then margin-notes are always hidden on small screens.
** Color of margin-note visibility-toggle and footnote-references
Margin-note visibility color toggle can be tweaked using something like
#+begin_src css
  label.margin-toggle {
      color: #a00000;
  }
#+end_src

For footnote references, something like below would work
#+begin_src css
  label.sidenote-number,
  .sidenote > sup.numeral {
      color: #a00000;
  }
#+end_src
* Compatibility
Ox-tufte is compatible and tested with tufte-css [[https://github.com/edwardtufte/tufte-css/releases][v1.1]], though it may work with
later versions. Please open issues if you discover any incompatibility!
* <<todos>>TODOs [1/3]
- [X] Better markup support in =marginnotes=
  Since =marginnotes= are currently implemented as hyperlinks, they presently
  lack the ability to embed images or have links within.
- [ ] Don't require users to explicitly download [[https://github.com/edwardtufte/tufte-css][tufte-css]]
- [ ] Support =#+CAPTION= on "figure" special blocks (say, when embedding an
  iframe). These are presently ignored. Note, for =iframe-wrapper= blocks even
  =tufte.css= doesn't support displaying =figcaption= blocks appropriately.
* References
- https://edwardtufte.github.io/tufte-css/
- https://gitlab.com/snippets/22309
